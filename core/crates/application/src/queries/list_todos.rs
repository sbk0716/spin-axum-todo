// =============================================================================
// application/src/queries/list_todos.rs: TODO 一覧取得クエリ
// =============================================================================
// 軽量 CQRS: 参照操作（Query）
// Reader DB プールを使用。
//
// 処理フロー:
// 1. TodoFilter を受け取る
// 2. TodoReader::find_all() を呼び出し
// 3. フィルタ条件に合致する TODO のリストを返す
//
// フィルタ条件（TodoFilter）:
// - user_id: 所有者でフィルタ（必須 - 認可）
// - completed: 完了状態でフィルタ（任意）
// =============================================================================

// -----------------------------------------------------------------------------
// 標準ライブラリのインポート
// -----------------------------------------------------------------------------

use std::sync::Arc; // スレッド安全な参照カウントスマートポインタ

// -----------------------------------------------------------------------------
// 外部クレートのインポート
// -----------------------------------------------------------------------------

use domain::{DomainError, Todo, TodoFilter, TodoReader}; // ドメイン層の型

// =============================================================================
// TODO 一覧取得クエリ構造体
// =============================================================================

/// TODO 一覧取得クエリ
///
/// 条件に合致する TODO のリストを取得する。
///
/// # フィルタ
///
/// TodoFilter には以下のフィールドがある:
/// - `user_id`: 必須。認可のため、所有する TODO のみ取得
/// - `completed`: 任意。true/false/None で完了状態をフィルタ
pub struct ListTodosQuery<R: TodoReader> {
    /// 読み取りリポジトリ
    reader: Arc<R>,
}

// -----------------------------------------------------------------------------
// Clone トレイト実装
// -----------------------------------------------------------------------------

impl<R: TodoReader> Clone for ListTodosQuery<R> {
    fn clone(&self) -> Self {
        Self {
            reader: Arc::clone(&self.reader),
        }
    }
}

// -----------------------------------------------------------------------------
// ListTodosQuery の実装
// -----------------------------------------------------------------------------

impl<R: TodoReader> ListTodosQuery<R> {
    /// 新しいクエリを作成
    ///
    /// # Arguments
    /// * `reader` - TodoReader の共有参照（Arc でラップ）
    pub fn new(reader: Arc<R>) -> Self {
        Self { reader }
    }

    /// TODO 一覧を取得する
    ///
    /// # Arguments
    /// * `filter` - フィルタ条件（user_id, completed など）
    ///
    /// # Returns
    /// * `Ok(Vec<Todo>)` - フィルタ条件に合致する TODO のリスト
    /// * `Err(DomainError::Repository)` - DB エラー
    ///
    /// # 空リストについて
    ///
    /// 条件に合致する TODO がない場合は空のベクター（`Vec::new()`）を返す。
    /// NotFound エラーにはならない（0 件は正常なケース）。
    pub async fn execute(&self, filter: TodoFilter) -> Result<Vec<Todo>, DomainError> {
        // Reader に委譲してフィルタ条件に合う TODO を取得
        self.reader.find_all(filter).await
    }
}
