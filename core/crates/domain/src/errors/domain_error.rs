// =============================================================================
// domain/src/errors/domain_error.rs: ドメインエラー型
// =============================================================================
// ドメイン層で発生するエラーを定義。
// 技術的な詳細（DB、キャッシュ）を抽象化したエラー型。
//
// エラー設計のポイント:
// - HTTP ステータスコードとの対応関係を明確に
// - 技術的詳細（sqlx::Error, redis::RedisError）を隠蔽
// - 上位層（presentation）でステータスコードに変換
//
// エラー変換の流れ:
// sqlx::Error → DomainError::Repository → AppError → HTTP 500
// =============================================================================

// -----------------------------------------------------------------------------
// 外部クレートのインポート
// -----------------------------------------------------------------------------

// thiserror: Rust のエラー型を簡潔に定義するためのマクロ群
// #[derive(Error)] で std::error::Error トレイトを自動実装
// #[error("...")] で Display トレイトの出力を定義
use thiserror::Error;

// =============================================================================
// ドメインエラー列挙型
// =============================================================================

/// ドメイン層のエラー型
///
/// ドメイン層で発生しうる全てのエラーを表現する列挙型（enum）。
/// 各バリアントは特定のエラー状況と HTTP ステータスコードに対応する。
///
/// # derive マクロの説明
///
/// - `Debug`: `{:?}` フォーマットでデバッグ出力可能に
/// - `Error`: thiserror クレートのマクロ
///   - `std::error::Error` トレイトを自動実装
///   - `#[error("...")]` で `Display` トレイトを実装
///
/// # エラーハンドリングの流れ
///
/// ```text
/// infrastructure層 → domain層 → application層 → presentation層
/// sqlx::Error     → Repository → ユースケース  → AppError(500)
/// ```
///
/// # 例: エラー変換
///
/// ```rust,ignore
/// // infrastructure 層での変換
/// sqlx::query!(...)
///     .fetch_one(&pool)
///     .await
///     .map_err(|e| DomainError::Repository(e.to_string()))?;
/// ```
#[derive(Debug, Error)]
pub enum DomainError {
    // -------------------------------------------------------------------------
    // クライアントエラー（4xx 系）
    // -------------------------------------------------------------------------
    /// バリデーションエラー（400 Bad Request に対応）
    ///
    /// リクエストデータが不正な場合に使用。
    ///
    /// # 使用例
    /// - タイトルが空文字
    /// - タイトルが 100 文字を超過
    /// - メールアドレスのフォーマットが不正
    ///
    /// # String の理由
    /// エラーメッセージを動的に生成するため String を使用。
    /// 例: `format!("Title must not exceed {} characters", MAX_LEN)`
    #[error("Validation error: {0}")]
    Validation(String),

    /// 認証エラー（401 Unauthorized に対応）
    ///
    /// 認証に失敗した場合に使用。
    ///
    /// # 使用例
    /// - パスワードが一致しない
    /// - JWT トークンが無効または期限切れ
    /// - ユーザーが存在しない（認証コンテキストで）
    ///
    /// # セキュリティ注意
    /// エラーメッセージは詳細にしすぎない。
    /// 「パスワードが違う」ではなく「認証情報が無効」のように。
    #[error("Authentication error: {0}")]
    Authentication(String),

    /// エンティティが見つからない（404 Not Found に対応）
    ///
    /// 指定された ID のエンティティが存在しない場合に使用。
    ///
    /// # 使用例
    /// - 存在しない TODO ID を指定
    /// - 削除済みのリソースにアクセス
    ///
    /// # なぜ String を含まないか
    /// NotFound は汎用的で、詳細メッセージは不要。
    /// どのエンティティが見つからないかは、
    /// 上位層（presentation）のコンテキストで判断できる。
    #[error("Entity not found")]
    NotFound,

    /// 重複エラー（409 Conflict に対応）
    ///
    /// 一意制約違反が発生した場合に使用。
    ///
    /// # 使用例
    /// - 既に登録済みのメールアドレスで登録しようとした
    /// - 一意であるべきフィールドが重複
    ///
    /// # DB エラーからの変換
    /// PostgreSQL の一意制約違反（23505）から変換される。
    #[error("Duplicate error: {0}")]
    Duplicate(String),

    // -------------------------------------------------------------------------
    // サーバーエラー（5xx 系）
    // -------------------------------------------------------------------------
    /// リポジトリエラー（500 Internal Server Error に対応）
    ///
    /// データベース操作が失敗した場合に使用。
    ///
    /// # 使用例
    /// - DB 接続エラー
    /// - SQL 実行エラー
    /// - トランザクション失敗
    ///
    /// # ログ
    /// このエラーは詳細をログに記録すべき。
    /// クライアントには詳細を返さない（セキュリティ）。
    #[error("Repository error: {0}")]
    Repository(String),

    /// キャッシュエラー（500 Internal Server Error に対応）
    ///
    /// Redis 操作が失敗した場合に使用。
    ///
    /// # 使用例
    /// - Redis 接続エラー
    /// - シリアライズ/デシリアライズ失敗
    ///
    /// # 特性
    /// キャッシュエラーは致命的でない場合が多い。
    /// キャッシュが利用できなくても、DB から直接取得可能。
    /// エラーをログに記録し、処理を継続することが多い。
    #[error("Cache error: {0}")]
    Cache(String),
}
