# =============================================================================
# Dockerfile: API サーバーのコンテナイメージ
# =============================================================================
# このファイルは API サーバーの Docker イメージをビルドする設定を定義する。
# マルチステージビルドを使用して、最終イメージサイズを最小化している。
#
# ビルド方法（rust-webapi ディレクトリで実行）:
#   docker build -f api/Dockerfile -t todo-api .
#
# 実行方法:
#   docker run -p 3000:3000 \
#     -e DATABASE_WRITER_URL=postgres://... \
#     -e REDIS_URL=redis://... \
#     todo-api
# =============================================================================

# =============================================================================
# Stage 1: builder（ビルドステージ）
# =============================================================================
# Rust のコンパイル環境でアプリケーションをビルドする。
# rust:1-bookworm は Debian Bookworm ベースの公式 Rust イメージ。
# "AS builder" でこのステージに名前を付け、後で参照できるようにする。
#
FROM rust:1-bookworm AS builder

# WORKDIR: 作業ディレクトリを設定
# 以降のコマンドはこのディレクトリで実行される
WORKDIR /app

# COPY: ローカルのファイルをコンテナにコピー
# "." "." はカレントディレクトリの全ファイルを /app にコピー
# ワークスペース全体（Cargo.toml, api/, shared/）が必要
COPY . .

# RUN: コンテナ内でコマンドを実行
# cargo build -p api --release:
# - -p api: api クレートのみをビルド
# - --release: 最適化されたリリースビルド（サイズ小・速度大）
RUN cargo build -p api --release

# =============================================================================
# Stage 2: runtime（実行ステージ）
# =============================================================================
# 実行に必要な最小限の環境のみを含む軽量イメージ。
# debian:bookworm-slim は Debian の最小構成イメージ（約 80MB）。
#
# マルチステージビルドの利点:
# - ビルドツール（rustc, cargo）が最終イメージに含まれない
# - イメージサイズが大幅に削減される（数GB → 数十MB）
# - セキュリティ向上（攻撃対象となるツールが少ない）
#
FROM debian:bookworm-slim

# 必要なパッケージをインストール
# - ca-certificates: HTTPS 通信に必要なルート証明書
#   （外部 API を呼び出す場合に必要）
# - rm -rf /var/lib/apt/lists/*: パッケージキャッシュを削除してイメージサイズを削減
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*

# 作業ディレクトリを設定
WORKDIR /app

# COPY --from=builder: 前のステージからファイルをコピー
# builder ステージでビルドした実行ファイルのみをコピー
# これにより、ソースコードやビルドの中間生成物は含まれない
COPY --from=builder /app/target/release/api /app/api

# EXPOSE: コンテナがリッスンするポートをドキュメント化
# 実際のポート公開は docker run -p で行う
EXPOSE 3000

# ENV: 環境変数を設定
# コンテナ内のアプリケーションは 0.0.0.0:3000 でリッスン
# 0.0.0.0 は全てのネットワークインターフェースを意味する
# （127.0.0.1 だとコンテナ外からアクセスできない）
ENV APP_ADDR=0.0.0.0:3000

# CMD: コンテナ起動時に実行するコマンド
# JSON 配列形式（exec form）を使用
# シェルを介さないため、シグナル処理が正しく行われる
CMD ["/app/api"]
