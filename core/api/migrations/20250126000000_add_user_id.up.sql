-- =============================================================================
-- 20250126000000_add_user_id.up.sql: マルチテナント対応
-- =============================================================================
-- todos テーブルに user_id を追加し、ユーザーごとに TODO を分離する。
-- 外部 IdP（Auth0, Cognito 等）を前提とし、users テーブルは作成しない。
-- =============================================================================

-- -----------------------------------------------------------------------------
-- user_id カラムを追加
-- -----------------------------------------------------------------------------
-- TEXT 型: JWT の sub クレームをそのまま格納
-- NOT NULL: すべての TODO は所有者を持つ必要がある
ALTER TABLE todos
ADD COLUMN user_id TEXT NOT NULL DEFAULT 'system';

-- 既存データのデフォルト値を削除（今後は明示的に指定が必要）
ALTER TABLE todos
ALTER COLUMN user_id DROP DEFAULT;

-- -----------------------------------------------------------------------------
-- インデックス: user_id でのフィルタリングを高速化
-- -----------------------------------------------------------------------------
-- ユーザーの TODO 一覧取得で使用される
-- user_id + created_at の複合インデックスで並び替えも高速化
CREATE INDEX idx_todos_user_id ON todos (user_id);
CREATE INDEX idx_todos_user_id_created_at ON todos (user_id, created_at DESC);
