# =============================================================================
# Spin アプリケーション設定ファイル
# =============================================================================
#
# このファイルは Spin アプリケーションの構成を定義します。
# - アプリケーションのメタデータ
# - HTTP トリガーの設定
# - コンポーネントの定義と依存関係（WIT コンポーネント合成）
#
# 参照: https://spinframework.dev/v3/manifest-reference

# -----------------------------------------------------------------------------
# マニフェストバージョン
# -----------------------------------------------------------------------------
# Spin マニフェストのバージョン（現在は 2 が最新）
spin_manifest_version = 2

# -----------------------------------------------------------------------------
# アプリケーション設定
# -----------------------------------------------------------------------------
[application]
# アプリケーション名（spin up 時に表示される）
name = "hybrid-arch-demo"

# アプリケーションのバージョン
version = "0.1.0"

# アプリケーションの説明
description = "Hybrid Architecture Demo - Edge layer with JWT authentication"

# 作者情報
authors = ["Demo Author"]

# -----------------------------------------------------------------------------
# HTTP トリガー設定
# -----------------------------------------------------------------------------
# アプリケーション全体の HTTP トリガー設定
[application.trigger.http]
# ベースパス（すべてのルートのプレフィックス）
base = "/"

# =============================================================================
# ゲートウェイコンポーネント
# =============================================================================
#
# HTTP リクエストのエントリーポイント。
# すべてのリクエストを受け取り、認証後にコア層へプロキシします。
#
# 処理フロー:
# 1. クライアントからのリクエストを受信
# 2. auth コンポーネントを呼び出して JWT を検証
# 3. 認証成功時、コア層（axum）にプロキシ
# 4. 認証失敗時、401 Unauthorized を返却

# HTTP トリガーの設定
[[trigger.http]]
# ルートパターン（"/..." はすべてのパスにマッチ）
# 例: /api/users, /api/users/1, /health など
route = "/..."

# このルートを処理するコンポーネント名
component = "gateway"

# ゲートウェイコンポーネントの定義
[component.gateway]
# Wasm バイナリのパス
# spin build で生成される成果物の場所
source = "target/wasm32-wasip1/release/gateway.wasm"

# 外部 HTTP 通信を許可するホスト
# コア層（axum サーバー）への通信を許可
# セキュリティのため、必要最小限のホストのみ指定
allowed_outbound_hosts = ["http://localhost:3001"]

# -----------------------------------------------------------------------------
# WIT コンポーネント合成設定
# -----------------------------------------------------------------------------
# gateway コンポーネントが auth コンポーネントの authenticator インターフェースを使用
#
# キー: "demo:auth/authenticator"
#   - demo:auth = WIT パッケージ名
#   - authenticator = インターフェース名
#
# 値: { component = "auth" }
#   - このインターフェースを提供するコンポーネント名
#
# これにより、gateway から auth の verify_token 関数を直接呼び出せる
dependencies = { "demo:auth/authenticator" = { component = "auth" } }

# ビルド設定
[component.gateway.build]
# ビルドコマンド（cargo で Wasm ターゲットにコンパイル）
# --release: 最適化ビルド
# --target wasm32-wasip1: WASI Preview 1 向け Wasm
# -p gateway: gateway パッケージのみビルド
command = "cargo build --release --target wasm32-wasip1 -p gateway"

# ビルド時の作業ディレクトリ
workdir = "."

# =============================================================================
# 認証コンポーネント
# =============================================================================
#
# JWT トークンの検証を担当するコンポーネント。
# gateway コンポーネントから WIT インターフェース経由で呼び出されます。
#
# 責務:
# - JWT トークンの構造検証
# - HMAC-SHA256 署名の検証
# - ユーザーIDの抽出
#
# 注意: このコンポーネントは HTTP トリガーを持たず、
# gateway からの内部呼び出しのみで使用されます。

[component.auth]
# Wasm バイナリのパス
source = "target/wasm32-wasip1/release/auth.wasm"

# ビルド設定
[component.auth.build]
# ビルドコマンド
command = "cargo build --release --target wasm32-wasip1 -p auth"

# ビルド時の作業ディレクトリ
workdir = "."
