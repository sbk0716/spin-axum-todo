// =============================================================================
// WIT (WebAssembly Interface Types) インターフェース定義
// =============================================================================
//
// このファイルは Wasm コンポーネント間のインターフェースを定義します。
// WIT は Wasm コンポーネントモデルの一部で、型安全なコンポーネント間通信を可能にします。
//
// 参照:
// - WIT 仕様: https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md
// - コンポーネントモデル: https://component-model.bytecodealliance.org/
//
// =============================================================================

// -----------------------------------------------------------------------------
// パッケージ宣言
// -----------------------------------------------------------------------------
// パッケージ名は "namespace:package" の形式で指定
// - namespace: 組織やプロジェクトを識別（例: wasi, demo）
// - package: パッケージ名（例: auth, http）
package demo:auth;

// =============================================================================
// authenticator インターフェース
// =============================================================================
//
// JWT 認証機能を提供するインターフェースです。
// auth コンポーネントがこのインターフェースをエクスポート（実装）し、
// gateway コンポーネントがインポート（使用）します。

/// 認証機能を提供するインターフェース
interface authenticator {
    // -------------------------------------------------------------------------
    // レコード型の定義
    // -------------------------------------------------------------------------
    //
    // record は Rust の struct、TypeScript の interface に相当します。
    // フィールドはケバブケース（kebab-case）で記述し、
    // 生成されるコードではスネークケース（snake_case）に変換されます。

    /// JWT 検証の結果を表すレコード型
    ///
    /// 認証の成功/失敗を示し、成功時はユーザーID、失敗時はエラーメッセージを含みます。
    record auth-result {
        /// 認証が成功したかどうか
        /// - true: JWT が有効で認証成功
        /// - false: JWT が無効または期限切れで認証失敗
        authenticated: bool,

        /// 認証成功時のユーザーID
        /// JWT の sub (Subject) クレームから抽出した値
        /// 認証失敗時は None (null)
        user-id: option<string>,

        /// 認証失敗時のエラーメッセージ
        /// 例: "Missing token", "Invalid signature", "Token expired"
        /// 認証成功時は None (null)
        error: option<string>,
    }

    // -------------------------------------------------------------------------
    // 関数の定義
    // -------------------------------------------------------------------------
    //
    // func キーワードで関数を定義します。
    // 引数と戻り値の型を指定し、実装は各コンポーネントで行います。

    /// JWT トークンを検証する
    ///
    /// Authorization ヘッダーから取得した Bearer トークンを検証し、
    /// 認証結果を返します。
    ///
    /// # 引数
    /// * `token` - 検証対象の JWT トークン文字列
    ///   - 空文字列の場合、"Missing token" エラー
    ///   - 不正な形式の場合、"Invalid token format" エラー
    ///
    /// # 戻り値
    /// * `auth-result` - 認証結果
    ///   - 成功時: authenticated=true, user-id=Some(ユーザーID)
    ///   - 失敗時: authenticated=false, error=Some(エラーメッセージ)
    ///
    /// # 検証内容
    /// 1. トークンが空でないこと
    /// 2. JWT フォーマット（header.payload.signature）であること
    /// 3. アルゴリズムが HS256 であること
    /// 4. HMAC-SHA256 署名が正しいこと
    /// 5. sub クレームが存在すること
    verify-token: func(token: string) -> auth-result;
}

// =============================================================================
// World 定義
// =============================================================================
//
// World はコンポーネントの「顔」を定義します。
// - export: コンポーネントが外部に提供するインターフェース
// - import: コンポーネントが外部から使用するインターフェース
//
// 各 Wasm コンポーネントは 1 つの world を実装します。

/// auth コンポーネントが実装する world
///
/// このコンポーネントは authenticator インターフェースをエクスポートし、
/// JWT 検証機能を外部に提供します。
///
/// 使用例:
/// - gateway コンポーネントから verify_token 関数が呼び出される
world auth-world {
    // authenticator インターフェースを外部に公開
    // これにより、他のコンポーネントがこのインターフェースを使用可能
    export authenticator;
}

/// gateway コンポーネントが実装する world
///
/// このコンポーネントは authenticator インターフェースをインポートし、
/// auth コンポーネントの機能を利用します。
///
/// 使用例:
/// - HTTP リクエストを受信
/// - auth コンポーネントの verify_token を呼び出して認証
/// - 認証成功時、コア層にプロキシ
world gateway-world {
    // authenticator インターフェースを使用
    // Spin のコンポーネント合成により、auth コンポーネントに接続される
    import authenticator;
}
